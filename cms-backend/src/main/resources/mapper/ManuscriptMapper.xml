<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjfu.cms.mapper.ManuscriptMapper">

    <resultMap id="ManuscriptMap" type="com.bjfu.cms.entity.Manuscript">
        <id property="manuscriptId" column="ManuscriptID"/>
        <result property="authorId" column="AuthorID"/>
        <result property="title" column="Title"/>
        <result property="abstractText" column="Abstract"/>
        <result property="keywords" column="Keywords"/>
        <result property="authorList" column="AuthorList"/>
        <result property="fundingInfo" column="FundingInfo"/>
        <result property="status" column="Status"/>
        <result property="submissionTime" column="SubmissionTime"/>

        <result property="keywords" column="Keywords"/>
        <result property="authorList" column="AuthorList"/>
        <result property="fundingInfo" column="FundingInfo"/>
        <result property="currentEditorId" column="CurrentEditorID"/>
        <result property="subStatus" column="SubStatus"/>
        <result property="decision" column="Decision"/>
        <result property="decisionTime" column="DecisionTime"/>
        <result property="editorRecommendation" column="EditorRecommendation"/>
        <result property="editorSummaryReport" column="EditorSummaryReport"/>
        <result property="recommendationDate" column="RecommendationDate"/>
    </resultMap>

    <select id="selectManuscripts" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        <where>
            <if test="authorId != null">
                AND AuthorID = #{authorId}
            </if>

            <if test="status != null and status != ''">
                AND Status = #{status}
            </if>

            <if test="subStatus != null and subStatus != ''">
                AND SubStatus = #{subStatus}
            </if>
        </where>
        ORDER BY SubmissionTime DESC
    </select>

    <insert id="insertManuscript" useGeneratedKeys="true" keyProperty="manuscriptId" keyColumn="ManuscriptID">
        INSERT INTO Manuscript
        (AuthorID, Title, Abstract, Keywords, AuthorList, FundingInfo, Status, SubStatus, SubmissionTime)
        VALUES
            (#{authorId}, #{title}, #{abstractText}, #{keywords}, #{authorList}, #{fundingInfo}, #{status}, #{subStatus}, GETDATE())
    </insert>

    <update id="updateManuscript">
        UPDATE Manuscript
        SET Title = #{title},
        Abstract = #{abstractText},
        Keywords = #{keywords},
        AuthorList = #{authorList},
        FundingInfo = #{fundingInfo},
        Status = #{status},
        SubmissionTime = #{submissionTime}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <insert id="insertVersion">
        INSERT INTO Versions
        (ManuscriptID, VersionNumber, OriginalFilePath, AnonymousFilePath,
         CoverLetterPath, MarkedFilePath, ResponseLetterPath, UploadTime)
        VALUES
            (#{manuscriptId}, #{versionNumber}, #{originalFilePath}, #{anonymousFilePath},
             #{coverLetterPath}, #{markedFilePath}, #{responseLetterPath}, GETDATE())
    </insert>

    <select id="selectMaxVersion" resultType="java.lang.Integer">
        SELECT MAX(VersionNumber) FROM Versions WHERE ManuscriptID = #{manuscriptId}
    </select>


    <select id="selectById" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript WHERE ManuscriptID = #{id}
    </select>

    <select id="selectAllManuscripts" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        <where>
            <if test="status != null and status != ''">
                AND Status = #{status}
            </if>
        </where>
        ORDER BY SubmissionTime DESC
    </select>

    <update id="updateStatus">
        UPDATE Manuscript
        SET Status = #{status}, SubStatus = #{subStatus}
        WHERE ManuscriptID = #{id}
    </update>

    <update id="updateCurrentEditor">
        UPDATE Manuscript
        SET CurrentEditorID = #{editorId}, SubStatus = #{subStatus}
        WHERE ManuscriptID = #{id}
    </update>

    <update id="updateFinalDecision">
        UPDATE Manuscript
        SET Decision = #{decision},
            Status = #{status},
            SubStatus = #{subStatus},
            DecisionTime = #{decisionTime},
            EditorSummaryReport = #{editorSummary}
        WHERE ManuscriptID = #{id}
    </update>

    <update id="updateManuscriptSpecial">
        UPDATE Manuscript
        SET Status = #{status}, SubStatus = #{subStatus}
        WHERE ManuscriptID = #{id}
    </update>

    <insert id="insertLog">
        INSERT INTO Logs (OperationTime, OperatorID, OperationType, ManuscriptID, Description)
        VALUES (#{time}, #{operatorId}, #{type}, #{manuscriptId}, #{description})
    </insert>

    <select id="selectTechCheckManuscripts" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        WHERE Status = 'Processing' AND SubStatus = 'TechCheck'
        ORDER BY SubmissionTime DESC
    </select>

    <select id="selectLatestOriginalFilePath" resultType="java.lang.String">
        SELECT TOP 1 OriginalFilePath
        FROM Versions
        WHERE ManuscriptID = #{manuscriptId}
        ORDER BY VersionNumber DESC
    </select>
    <resultMap id="LogMap" type="com.bjfu.cms.entity.SystemLog">
        <id property="logId" column="LogID"/>
        <result property="operationTime" column="OperationTime"/>
        <result property="operatorId" column="OperatorID"/>
        <result property="operationType" column="OperationType"/>
        <result property="manuscriptId" column="ManuscriptID"/>
        <result property="description" column="Description"/>
        <result property="operatorName" column="OperatorName"/>
    </resultMap>

    <select id="selectLogsByManuscriptId" resultMap="LogMap">
        SELECT
            l.*,
            u.UserName as OperatorName
        FROM Logs l
                 LEFT JOIN User u ON l.OperatorID = u.UserID
        WHERE l.ManuscriptID = #{manuscriptId}
        ORDER BY l.OperationTime DESC
    </select>

</mapper>