<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjfu.cms.mapper.ManuscriptMapper">

    <resultMap id="ManuscriptMap" type="com.bjfu.cms.entity.Manuscript">
        <id property="manuscriptId" column="ManuscriptID"/>
        <result property="authorId" column="AuthorID"/>
        <result property="title" column="Title"/>
        <result property="abstractText" column="Abstract"/>
        <result property="keywords" column="Keywords"/>
        <result property="authorList" column="AuthorList"/>
        <result property="fundingInfo" column="FundingInfo"/>
        <result property="status" column="Status"/>
        <result property="submissionTime" column="SubmissionTime"/>

        <result property="currentEditorId" column="CurrentEditorID"/>
        <result property="subStatus" column="SubStatus"/>
        <result property="decision" column="Decision"/>
        <result property="decisionTime" column="DecisionTime"/>
        <result property="editorRecommendation" column="EditorRecommendation"/>
        <result property="editorSummaryReport" column="EditorSummaryReport"/>
        <result property="recommendationDate" column="RecommendationDate"/>
    </resultMap>

    <select id="selectManuscripts" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        <where>
            <if test="authorId != null">
                AND AuthorID = #{authorId}
            </if>

            <if test="status != null and status != ''">
                AND Status = #{status}
            </if>

            <if test="subStatus != null and subStatus != ''">
                AND SubStatus = #{subStatus}
            </if>
        </where>
        ORDER BY SubmissionTime DESC
    </select>


    <select id="selectByAuthorId" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        WHERE AuthorID = #{authorId}
        ORDER BY SubmissionTime DESC
    </select>

    <select id="selectByEditorId" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        WHERE CurrentEditorID = #{editorId}
        ORDER BY SubmissionTime DESC
    </select>



    <insert id="insertManuscript" useGeneratedKeys="true" keyProperty="manuscriptId" keyColumn="ManuscriptID">
        INSERT INTO Manuscript
        (AuthorID, Title, Abstract, Keywords, AuthorList, FundingInfo, Status, SubStatus, SubmissionTime)
        VALUES
            (#{authorId}, #{title}, #{abstractText}, #{keywords}, #{authorList}, #{fundingInfo}, #{status}, #{subStatus}, GETDATE())
    </insert>

    <update id="updateManuscript">
        UPDATE Manuscript
        SET Title = #{title},
            Abstract = #{abstractText},
            Keywords = #{keywords},
            AuthorList = #{authorList},
            FundingInfo = #{fundingInfo},
            Status = #{status},
            SubmissionTime = #{submissionTime}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <!-- 新增：撤稿更新操作，包含所有必要字段 -->
    <update id="updateRetractManuscript">
        UPDATE Manuscript
        SET Status = #{status},
            SubStatus = #{subStatus},
            Decision = #{decision},
            DecisionTime = GETDATE(),
            RetractTime = #{retractTime},
            RetractByUserID = #{retractByUserId},
            RetractReason = #{retractReason},
            RetractType = #{retractType}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <insert id="insertVersion">
        INSERT INTO Versions
        (ManuscriptID, VersionNumber, OriginalFilePath, AnonymousFilePath,
         CoverLetterPath, MarkerFilePath, ResponseLetterPath, UploadTime) VALUES
            (#{manuscriptId}, #{versionNumber}, #{originalFilePath}, #{anonymousFilePath},
             #{coverLetterPath}, #{markedFilePath}, #{responseLetterPath}, GETDATE())
    </insert>

    <select id="selectMaxVersion" resultType="java.lang.Integer">
        SELECT MAX(VersionNumber) FROM Versions WHERE ManuscriptID = #{manuscriptId}
    </select>


    <select id="selectById" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript WHERE ManuscriptID = #{id}
    </select>

    <select id="selectAllManuscripts" resultMap="ManuscriptMap">
        SELECT m.*, u.FullName as AuthorName
        FROM Manuscript m
        LEFT JOIN Users u ON m.AuthorID = u.UserID
        <where>
            <if test="status != null and status != ''">
                AND m.Status = #{status}
            </if>
        </where>
        ORDER BY m.SubmissionTime DESC
    </select>


    <update id="updateCurrentEditor">
        UPDATE Manuscript
        SET CurrentEditorID = #{editorId},
            Status = 'Processing',   SubStatus = #{subStatus}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <!-- 添加 selectByPrimaryKey 方法 -->
    <select id="selectByPrimaryKey" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript WHERE ManuscriptID = #{manuscriptId}
    </select>

    <update id="updateFinalDecision">
        UPDATE Manuscript
        SET Decision = #{decision},
            Status = #{status},
            SubStatus = #{subStatus},
            DecisionTime = #{finalDecisionDate},
            EditorSummaryReport = #{comments}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <update id="updateStatus">
        UPDATE Manuscript
        SET Status = #{status},
            SubStatus = #{subStatus}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <update id="updateCurrentEditorAndStatus">
        UPDATE Manuscript
        SET CurrentEditorID = #{editorId},
            Status = #{status},
            SubStatus = #{subStatus}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <update id="updateManuscriptSpecial">
        UPDATE Manuscript
        SET Status = #{status},
            SubStatus = #{subStatus}
        WHERE ManuscriptID = #{manuscriptId}
    </update>

    <insert id="insertLog">
        INSERT INTO Logs (OperationTime, OperatorID, OperationType, ManuscriptID, Description)
        VALUES (#{operationTime}, #{operatorId}, #{operationType}, #{manuscriptId}, #{description})
    </insert>

    <select id="selectTechCheckManuscripts" resultMap="ManuscriptMap">
        SELECT * FROM Manuscript
        WHERE Status = 'Processing' AND SubStatus = 'TechCheck'
        ORDER BY SubmissionTime DESC
    </select>

    <select id="selectLatestOriginalFilePath" resultType="java.lang.String">
        SELECT TOP 1 OriginalFilePath
        FROM Versions
        WHERE ManuscriptID = #{manuscriptId}
        ORDER BY VersionNumber DESC
    </select>

    <resultMap id="LogMap" type="com.bjfu.cms.entity.SystemLog">
        <id property="logId" column="LogID"/>
        <result property="operationTime" column="OperationTime"/>
        <result property="operatorId" column="OperatorID"/>
        <result property="operationType" column="OperationType"/>
        <result property="manuscriptId" column="ManuscriptID"/>
        <result property="description" column="Description"/>
        <result property="operatorName" column="OperatorName"/>
    </resultMap>

    <select id="selectLogsByManuscriptId" resultMap="LogMap">
        SELECT
            l.*,
            u.UserName as OperatorName
        FROM Logs l
                 LEFT JOIN Users u ON l.OperatorID = u.UserID
        WHERE l.ManuscriptID = #{manuscriptId}
        ORDER BY l.OperationTime DESC
    </select>

    <resultMap id="ManuscriptReviewMap" type="com.bjfu.cms.entity.Manuscript">
        <id property="manuscriptId" column="ManuscriptID"/>
        <result property="title" column="Title"/>
        <result property="abstractText" column="Abstract"/>
        <result property="keywords" column="Keywords"/>
        <result property="authorList" column="AuthorList"/>
    </resultMap>

    <select id="selectManuscriptForReview" resultMap="ManuscriptReviewMap">
        SELECT
            ManuscriptID, Title, Abstract, Keywords, AuthorList
        FROM Manuscript
        WHERE ManuscriptID = #{manuscriptId}
    </select>

    <select id="selectLatestAnonymousFilePath" resultType="java.lang.String">
        SELECT TOP 1 AnonymousFilePath
        FROM Versions
        WHERE ManuscriptID = #{manuscriptId}
        ORDER BY VersionNumber DESC
    </select>

    <resultMap id="ReviewTrackingMap" type="com.bjfu.cms.entity.dto.ReviewTrackingDTO">
        <id property="manuscriptId" column="ManuscriptID"/>
        <result property="title" column="Title"/>
        <result property="keywords" column="Keywords"/>
        <result property="subStatus" column="SubStatus"/>

        <collection property="opinions" ofType="com.bjfu.cms.entity.dto.ReviewOpinionDTO">
            <id property="reviewId" column="ReviewID"/>
            <result property="reviewerName" column="ReviewerName"/>
            <result property="score" column="Score"/>
            <result property="suggestion" column="Suggestion"/>
            <result property="confidentialComments" column="ConfidentialComments"/>
            <result property="status" column="ReviewStatus"/>
        </collection>
    </resultMap>

    <select id="selectTrackingWithOpinions" resultMap="ReviewTrackingMap">
        SELECT
            m.ManuscriptID,
            m.Title,
            m.Keywords,
            m.SubStatus,
            r.ReviewID,
            u.FullName AS ReviewerName,
            r.Score,
            r.Suggestion,
            r.ConfidentialComments,
            r.Status AS ReviewStatus
        FROM Manuscript m
                 LEFT JOIN Review r ON m.ManuscriptID = r.ManuscriptID
                 LEFT JOIN Users u ON r.ReviewerID = u.UserID
        WHERE m.CurrentEditorID = #{editorId}
          -- 核心修改：只查询处于外审状态的稿件
          AND m.SubStatus = 'UnderReview'
        ORDER BY m.ManuscriptID DESC
    </select>

</mapper>