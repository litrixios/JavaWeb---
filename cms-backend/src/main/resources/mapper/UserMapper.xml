<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjfu.cms.mapper.UserMapper">

    <resultMap id="UserMap" type="com.bjfu.cms.entity.User">
        <id property="userId" column="UserID"/>
        <result property="username" column="Username"/>
        <result property="password" column="Password"/>
        <result property="role" column="Role"/>
        <result property="email" column="Email"/>
        <result property="fullName" column="FullName"/>
        <result property="registerTime" column="RegisterTime"/>
        <result property="status" column="Status"/>
        <result property="affiliation" column="Affiliation"/>
        <result property="researchDirection" column="ResearchDirection"/>
        <association property="permissions" javaType="com.bjfu.cms.entity.UserPermission">
            <id property="userId" column="UserID"/>
            <result property="canSubmitManuscript" column="CanSubmitManuscript"/>
            <result property="canMakeDecision" column="CanMakeDecision"/>
        </association>
    </resultMap>

    <select id="findByUsername" resultMap="UserMap">
        SELECT u.*, p.*
        FROM Users u
                 LEFT JOIN UserPermissions p ON u.UserID = p.UserID
        WHERE u.Username = #{username}
    </select>



    <insert id="insertPermissions">
        INSERT INTO UserPermissions (UserID, CanSubmitManuscript, CanMakeDecision)
        VALUES (#{userId}, #{canSubmitManuscript}, #{canMakeDecision})
    </insert>

    <update id="updateUserStatus">
        UPDATE Users
        SET Status = #{status}
        WHERE UserID = #{userId}
    </update>

    <insert id="insertUser" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO Users (Username, Password, Role, Email, FullName, ResearchDirection,Affiliation, Status, RegisterTime)
        VALUES (#{username},#{password},#{role}, #{email}, #{fullName}, #{researchDirection},#{affiliation}, #{status}, #{registerTime})
    </insert>

    <insert id="insertLog">
        INSERT INTO Logs (OperationTime, OperatorID, OperationType, ManuscriptID, Description)
        VALUES (#{operationTime}, #{operatorId}, #{operationType}, #{manuscriptId}, #{description})
    </insert>

    <select id="selectById" resultMap="UserMap">
        SELECT u.*, p.*
        FROM Users u
                 LEFT JOIN UserPermissions p ON u.UserID = p.UserID
        WHERE u.UserID = #{userId}
    </select>


    <!-- 根据邮箱查询用户 -->
    <select id="findByEmail" resultType="com.bjfu.cms.entity.User">
        SELECT * FROM Users WHERE Email = #{email}
    </select>

    <select id="selectUsersByRole" resultType="com.bjfu.cms.entity.User">
        SELECT UserID, FullName, Email, Affiliation, ResearchDirection
        FROM Users
        WHERE Role = #{role} AND Status = 1
    </select>

    <!-- 查询编辑列表 -->
    <select id="selectEditors" resultMap="UserMap">
        SELECT u.*
        FROM Users u
        WHERE u.Role IN ('Editor', 'AssociateEditor')
          AND u.Status = 1  -- 只查询正常状态的用户
        ORDER BY u.FullName
    </select>

    <!-- 根据角色查询用户 -->
    <select id="selectByRole" resultMap="UserMap">
        SELECT u.*
        FROM Users u
        WHERE u.Role = #{role}
        ORDER BY u.FullName
    </select>

    <!-- 查询所有审稿人 -->
    <select id="selectReviewers" resultMap="UserMap">
        SELECT u.*
        FROM Users u
        WHERE u.Role = 'Reviewer'
          AND u.Status = 1
        ORDER BY u.FullName
    </select>

    <!-- 统计稿件数量 -->
    <select id="countManuscriptsByStatus" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM Manuscript WHERE Status = #{status}
    </select>

    <!-- 查询稿件及其作者信息 -->
    <select id="selectManuscriptsWithAuthors" resultType="java.util.Map">
        SELECT
        m.ManuscriptID as manuscriptId,
        m.Title as title,
        m.Abstract as abstractText,
        m.AuthorList as authorList,
        m.Status as status,
        m.SubStatus as subStatus,
        m.CurrentEditorID as currentEditorId,
        m.SubmissionTime as submissionTime,
        m.Decision as decision,
        m.DecisionTime as decisionTime,
        u.FullName as authorName,
        u.Email as authorEmail
        FROM Manuscript m
        LEFT JOIN Users u ON m.AuthorID = u.UserID
        <if test="status != null">
            WHERE m.Status = #{status}
        </if>
        ORDER BY m.SubmissionTime DESC
    </select>


    <!-- 插入新用户 -->
<!--    <insert id="insertUser" parameterType="com.bjfu.cms.entity.User" useGeneratedKeys="true" keyProperty="userId">-->
<!--        INSERT INTO Users (Username, Password, Email, FullName, Role, Affiliation, ResearchDirection, RegisterTime, Status)-->
<!--        VALUES (#{username}, #{password}, #{email}, #{fullName}, #{role}, #{affiliation}, #{researchDirection}, #{registerTime}, #{status})-->
<!--    </insert>-->

    <!-- 插入用户权限 -->
    <insert id="insertUserPermissions" parameterType="com.bjfu.cms.entity.UserPermission">
        INSERT INTO UserPermissions (UserID, CanSubmitManuscript, CanViewAllManuscripts, CanAssignReviewer, CanViewReviewerIdentity, CanWriteReview, CanMakeDecision, CanModifySystemConfig, CanTechCheck, CanPublishNews)
        VALUES (#{userId}, #{canSubmitManuscript}, #{canViewAllManuscripts}, #{canAssignReviewer}, #{canViewReviewerIdentity}, #{canWriteReview}, #{canMakeDecision}, #{canModifySystemConfig}, #{canTechCheck}, #{canPublishNews})
    </insert>
</mapper>