<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjfu.cms.mapper.InternalMessageMapper">

    <resultMap id="MessageMap" type="com.bjfu.cms.entity.InternalMessage">
        <id property="messageId" column="MessageID"/>
        <result property="senderId" column="SenderID"/>
        <result property="receiverId" column="ReceiverID"/>
        <result property="topic" column="Topic"/>
        <result property="title" column="Title"/>
        <result property="content" column="Content"/>
        <result property="isRead" column="IsRead"/>
        <result property="sendTime" column="SendTime"/>

        <result property="msgType" column="MsgType"/>

        <result property="senderName" column="SenderName"/>
        <result property="senderRole" column="SenderRole"/>
    </resultMap>

    <select id="selectByReceiverId" resultMap="MessageMap">
        SELECT
            m.*,
            u.FullName AS SenderName,
            u.Role AS SenderRole
        FROM InternalMessage m
                 LEFT JOIN Users u ON m.SenderID = u.UserID
        WHERE m.ReceiverID = #{receiverId}
        ORDER BY m.SendTime DESC
    </select>

    <insert id="insertMessage" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO InternalMessage (
            SenderID, ReceiverID, Topic, Title, Content, IsRead, SendTime, MsgType
        )
        VALUES (
                   #{senderId}, #{receiverId}, #{topic}, #{title}, #{content}, 0, GETDATE(), #{msgType}
               )
    </insert>

    <update id="markAsRead">
        UPDATE InternalMessage SET IsRead = 1 WHERE MessageID = #{messageId}
    </update>

    <select id="selectByTopicAndUser" resultMap="MessageMap">
        SELECT
            m.*,
            sender.Username AS SenderName,
            sender.Role AS SenderRole
        FROM InternalMessage m
                 LEFT JOIN Users sender ON m.SenderID = sender.UserID
        WHERE m.Topic = #{topic}
          AND (m.SenderID = #{userId} OR m.ReceiverID = #{userId})
          AND m.MsgType = 1
        ORDER BY m.SendTime ASC
    </select>

    <select id="selectAllMessagesForUser" resultMap="MessageMap">
        SELECT
            m.*,
            sender.FullName AS SenderName,
            sender.Role AS SenderRole
        FROM InternalMessage m
                 LEFT JOIN Users sender ON m.SenderID = sender.UserID
        WHERE m.ReceiverID = #{userId} OR m.SenderID = #{userId}
        ORDER BY m.SendTime DESC
    </select>

    <select id="selectByTypeAndReceiver" resultMap="MessageMap">
        SELECT
            m.*,
            u.FullName AS SenderName,
            u.Role AS SenderRole
        FROM InternalMessage m
                 LEFT JOIN Users u ON m.SenderID = u.UserID
        WHERE m.ReceiverID = #{receiverId}
          AND m.MsgType = #{msgType}
        ORDER BY m.SendTime DESC
    </select>

    <update id="markSystemMessagesAsRead">
        UPDATE InternalMessage
        SET IsRead = 1
        WHERE ReceiverID = #{userId}
          AND MsgType = 0
          AND IsRead = 0
    </update>

</mapper>