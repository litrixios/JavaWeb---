<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bjfu.cms.mapper.ReviewMapper">

    <resultMap id="ReviewMap" type="com.bjfu.cms.entity.Review">
        <id property="reviewId" column="ReviewID"/>
        <result property="manuscriptID" column="ManuscriptID"/>
        <result property="reviewerID" column="ReviewerID"/>
        <result property="inviteDate" column="InviteDate"/>
        <result property="deadline" column="Deadline"/>
        <result property="submitTime" column="SubmitTime"/>
        <result property="status" column="Status"/>
        <result property="score" column="Score"/>
        <result property="suggestion" column="Suggestion"/>
        <result property="commentsToAuthor" column="CommentsToAuthor"/>
        <result property="confidentialComments" column="ConfidentialComments"/>

        <result property="manuscriptTitle" column="Title"/>
        <result property="manuscriptAbstract" column="Abstract"/>
    </resultMap>

    <select id="selectPendingInvitations" resultMap="ReviewMap">
        SELECT r.ReviewID, r.ManuscriptID, r.ReviewerID, r.InviteDate, r.Deadline, r.Status,
               m.Title, m.Abstract
        FROM Review r
                 LEFT JOIN Manuscript m ON r.ManuscriptID = m.ManuscriptID
        WHERE r.ReviewerID = #{reviewerId}
          AND r.Status = 'Invited'
        ORDER BY r.InviteDate DESC
    </select>

    <select id="selectMyReviews" resultMap="ReviewMap">
        SELECT r.ReviewID, r.ManuscriptID, r.ReviewerID, r.InviteDate, r.Deadline,
               r.Status, r.SubmitTime, r.Score, r.Suggestion,
               m.Title, m.Abstract
        FROM Review r
                 LEFT JOIN Manuscript m ON r.ManuscriptID = m.ManuscriptID
        WHERE r.ReviewerID = #{reviewerId}
          AND r.Status IN ('Accepted', 'Completed')
        ORDER BY
            CASE WHEN r.Status = 'Accepted' THEN 0 ELSE 1 END, -- 优先显示未完成的任务
            r.Deadline ASC
    </select>

    <select id="selectById" resultMap="ReviewMap">
        SELECT * FROM Review
        WHERE ReviewID = #{reviewId}
    </select>

    <update id="updateStatus">
        UPDATE Review
        SET Status = #{status}
        WHERE ReviewID = #{reviewId}
          AND ReviewerID = #{reviewerId}
    </update>

    <update id="updateRejectionReason">
        UPDATE Review
        SET ConfidentialComments = #{reason}
        WHERE ReviewID = #{reviewId}
    </update>

    <update id="updateReviewComments" parameterType="com.bjfu.cms.entity.dto.ReviewSubmitDTO">
        UPDATE Review
        SET ConfidentialComments = #{confidentialComments},
            CommentsToAuthor = #{authorComments},
            Score = ROUND((#{innovationScore} * 0.3) + (#{methodologyScore} * 0.3) + (#{qualityScore} * 0.4), 1),
            Suggestion = #{recommendation}
        WHERE ReviewID = #{reviewId}
    </update>

    <update id="completeReview">
        UPDATE Review SET Status = 'Completed', SubmitTime = #{finishDate}
        WHERE ReviewID = #{reviewId}
    </update>

</mapper>