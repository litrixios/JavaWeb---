<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bjfu.cms.mapper.EditorMapper">

    <select id="selectMyManuscripts" resultType="com.bjfu.cms.entity.Manuscript">
        SELECT
            ManuscriptID as manuscriptId, AuthorID as authorId,
            CurrentEditorID as currentEditorId, Title,
            Abstract as abstractText, Keywords, Status, SubStatus as subStatus,
            SubmissionTime as submissionTime, RevisionDeadline as revisionDeadline
        FROM Manuscript
        WHERE CurrentEditorID = #{editorId}
    </select>

    <insert id="batchInsertReviews">
        INSERT INTO Review (ManuscriptID, ReviewerID, Status, Deadline, InviteDate)
        VALUES
        <foreach collection="rIds" item="rId" separator=",">
            (#{msId}, #{rId}, 'Invited', #{deadline}, GETDATE())
        </foreach>
    </insert>

    <update id="updateSubStatus">
        UPDATE Manuscript
        SET SubStatus = #{sub},
            Status = 'Processing'  -- 强制同步大状态，防止违反 CK_Status_Logic
        WHERE ManuscriptID = #{msId}
    </update>

    <update id="updateRecommendation">
        UPDATE Manuscript
        SET EditorRecommendation = #{editorRecommendation},
            EditorSummaryReport = #{editorSummaryReport},
            RecommendationDate = GETDATE(),
            SubStatus = 'PendingEICDecision',
            Status = 'Processing' -- 显式声明大状态，确保安全
        WHERE ManuscriptID = #{manuscriptId} AND CurrentEditorID = #{currentEditorId}
    </update>
</mapper>